/*! testnode 2016-02-26 */
var nodemysql=require("mysql"),StrExt=require("liucr-strext");StrExt.Load();var mysqlop=function(a){this.option=a,this.connection=null,this.connect=function(){if(void 0===this.option)throw new Error("None options");return null===this.connection&&(this.connection=nodemysql.createConnection(this.option),this.connection.config.queryFormat=function(a,b){return b?a.replace(/\ :(\w+)/g,function(a,c){return b.hasOwnProperty(c)?this.escape(b[c]):a}.bind(this)):a}),"disconnected"==this.connection.state&&(this.connection.connect(),this.connection.config.queryFormat=function(a,b){return b?a.replace(/\ :(\w+)/g,function(a,c){return b.hasOwnProperty(c)?this.escape(b[c]):a}.bind(this)):a}),this.connection},this.disconnect=function(){this.connection=nodemysql.end()}};mysqlop.prototype.GetMaxID=function(a,b,c){var d=this.connect();d.query(String.format("select max({0}) max from {1}",a,b),function(a,b,d){if(a)throw a;c(b[0].max)})},mysqlop.prototype.Exists=function(a,b,c){var d=this.connect();d.query(a,b,function(a,b){if(a)throw a;c(b.length>=1)})},mysqlop.prototype.ExecuteSql=function(a,b,c){var d=this.connect();d.query(a,b,function(a,b){if(a)throw a;c(b)})},mysqlop.prototype.ExecuteSqlByTime=function(a,b,c){var d=this.connect();d.query({sql:a,timeout:b},function(a,b){if(a)throw a;c(b)})},mysqlop.prototype.ExecuteSqlTran=function(a,b,c){var d=this.connect();d.beginTransaction(function(b){if("string"==typeof a&&d.query(a,function(a,b){return a?d.rollback(function(){c({err:a})}):void c({result:b})}),a instanceof Array){for(var e in a)d.query(a[e],function(b,f){return b?d.rollback(function(){c({err:b,statement:a[e]})}):void 0});d.commit(function(a){a&&c({err:a}),c({result:"success"})})}})},mysqlop.prototype.GetSingle=function(a,b,c){},mysqlop.prototype.ExecuteReader=function(a,b){},mysqlop.prototype.Query=function(a,b,c,d){},mysqlop.prototype.QueryMulti=function(a,b,c,d){var e=this.connect();if(!this.option.multipleStatements)throw new Error("Current settings not allow multiple statements query.");e.query(a,b,function(a,b){if(a)throw a;d(b)})},mysqlop.prototype.ExecuteSqlTranWithIndentity=function(a,b){},exports.mysqlop=mysqlop;